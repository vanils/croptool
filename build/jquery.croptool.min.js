/*
 *
 * jQuery Croptool v1.0.0
 * http://github.com/vanils/croptool
 *
 * Copyright 2014, Matti Mehtonen
 * Licensed under the MIT license.
 * http://github.com/vanils/croptool/blob/master/LICENSE
 *
 */
!function(a,b,c,d){"use strict";var e;e=function(a,b){var d=this;d.element=a,d.options=c.extend({},b),d.mode=e.MODE_NORMAL,d.state=e.STATE_NULL,d.direction=e.DIRECTION_BOTH,d.initOptions(function(){d.createDOM(a),d.attachListeners(),d.selection&&d.requestUpdate()})},e.MODE_CENTER=1,e.MODE_NORMAL=2,e.STATE_NULL=3,e.STATE_MOVE=4,e.STATE_RESIZE=5,e.DIRECTION_VERTICAL=6,e.DIRECTION_HORIZONTAL=7,e.DIRECTION_BOTH=8,e.defaults={dots:!0,keyboard:!0,margin:.02,movable:!0,resizable:!0,persistent:!0},e.template=function(){var a,c,d=b.createElement("div"),e=b.createElement("div"),f=b.createElement("div"),g=b.createElement("div"),h=b.createElement("div"),i="top|top-right|right|bottom-right|bottom|bottom-left|left|top-left".split("|"),j="croptool-";for(d.className=j+"wrapper",e.className=j+"container",f.className=j+"selection",g.className=j+"remnant",h.className=j+"point",c=0;4>c;c++)a=g.cloneNode(!1),a.className+=" "+j+"remnant-"+i[2*c],f.appendChild(a);for(c=0;8>c;c++)a=h.cloneNode(!1),a.className+=" "+j+"point-"+i[c],f.appendChild(a);return e.appendChild(f),d.appendChild(e),d}(),e.requestAnimationFrame=function(){for(var b=["oRequestAnimationFrame","webkitRequestAnimationFrame","mozRequestAnimationFrame","msRequestAnimationFrame"],c="requestAnimationFrame";c;){if(a[c])return c;c=b.pop()}return!1}(),e.getPointFromEvent=function(a){var b,c=a.type,d={};return"touchstart"===c?(b=a.touches,d.x=b[0].pageX,d.y=b[0].pageY):"touchmove"===c?(b=a.touches,d.x=b[0].pageX,d.y=b[0].pageY):"touchend"===c?(b=a.changedTouches,d.x=b[0].pageX,d.y=b[0].pageY):(d.x=a.pageX,d.y=a.pageY),d},e.prototype.createDOM=function(a){var b,d=c(a),f=c(e.template.cloneNode(!0)),g=c(".croptool-container",f),h=c(".croptool-selection",f);this.elements={$container:g,$selection:h,container:g[0],selection:h[0]},d.parent().append(f),g.append(d),b=h.css("outline-width"),b?parseInt(b,10)||h.addClass("no-outline"):h.addClass("no-outline"),this.options.dots||h.addClass("no-dots")},e.prototype.attachListeners=function(){var d=c(a),f=c("body"),g=this;d.on("keydown",function(a){18===a.which&&(g.mode=e.MODE_CENTER,g.state!==e.STATE_NULL&&g.updateSelection())}),d.on("keyup",function(a){18===a.which&&(g.mode=e.MODE_NORMAL,g.state!==e.STATE_NULL&&g.updateSelection())}),f.on("mousedown",function(a){1===a.which&&g.dragStart(a)}),f.on("mousemove",function(a){g.dragMove(a)}),f.on("mouseup",function(a){g.dragEnd(a)}),f.on("mouseleave",function(a){g.dragEnd(a)}),c(b).on("mouseleave",function(a){g.dragEnd(a)})},e.prototype.initOptions=function(a){var d,e,f=this,g=f.options;d=function(){"undefined"==typeof g.max?g.max=g.real:(g.max.w=g.max.w<0?Math.real.w:Math.min(g.max.w,g.real.w),g.max.h=g.max.h<0?Math.real.h:Math.min(g.max.h,g.real.h)),"undefined"==typeof g.min?g.min={w:0,h:0,wp:0,hp:0}:(g.min.wp=g.min.w/g.real.w,g.min.hp=g.min.h/g.real.h),g.max.wp=g.max.w/g.real.w,g.max.hp=g.max.h/g.real.h,g.selection&&(f.selection=f.convertSelection(g.selection,!0)),"function"==typeof a&&a()},g.real?d():(e=c(b.createElement("img")),e.on("load",function(){f.options.real={w:e.prop("width"),h:e.prop("height")},d()}),e.attr("src",f.element.src+"?"+(new Date).getTime()))},e.prototype.requestUpdate=function(){var b=this;b.updatePending||(e.requestAnimationFrame?(b.updatePending=!0,a[e.requestAnimationFrame](function(){b.updatePending=!1,b.doUpdate()})):b.doUpdate())},e.prototype.doUpdate=function(){this.elements.$selection.css("display","none"),this.selection&&(this.elements.$selection.css("left",100*this.selection.x+"%"),this.elements.$selection.css("top",100*this.selection.y+"%"),this.elements.$selection.css("width",100*this.selection.w+"%"),this.elements.$selection.css("height",100*this.selection.h+"%"),this.elements.$selection.css("display","block"))},e.prototype.convertPoint=function(a){var b=this.elements.$container.offset();return{x:(a.x-b.left)/this.elements.container.offsetWidth,y:(a.y-b.top)/this.elements.container.offsetHeight}},e.prototype.convertSelection=function(a,b){var c,d,e,f,g=this.options;return b?{x:a.x/g.real.w,y:a.y/g.real.h,w:a.w/g.real.w,h:a.h/g.real.h}:(e=g.max,f=g.min,c={x:Math.round(a.x*g.real.w),y:Math.round(a.y*g.real.h),w:Math.round(a.w*g.real.w),h:Math.round(a.h*g.real.h)},f&&("undefined"!=typeof f.w&&c.w<f.w&&(c.w=f.w),"undefined"!=typeof f.h&&c.h<f.h&&(c.h=f.h)),e&&("undefined"!=typeof e.w&&c.w>e.w&&(c.w=e.w),"undefined"!=typeof e.h&&c.h>e.h&&(c.h=e.h)),d=c.x+c.w,d>g.real.w&&(c.x-=d-g.real.w),d=c.y+c.h,d>g.real.h&&(c.y-=d-g.real.h),c.x=Math.abs(c.x),c.y=Math.abs(c.y),c.w=Math.abs(c.w),c.h=Math.abs(c.h),c)},e.prototype.testSelectionHit=function(a){var b=this.selection,c=this.options.margin;return b?a.y<b.y-c||a.y>b.y+b.h+c?!1:a.x<b.x-c||a.x>b.x+b.w+c?!1:!0:!1},e.prototype.testComponentHit=function(a){return a.y<0||a.y>1||a.x<0||a.x>1?!1:!0},e.prototype.getOrigin=function(a){var b,c,d=this.selection,e=this.options.margin;return d&&(a.x>=d.x-e&&a.x<=d.x+e?b=1:a.x>=d.x+d.w-e&&a.x<=d.x+d.w+e&&(b=0),a.y>=d.y-e&&a.y<=d.y+e?c=1:a.y>=d.y+d.h-e&&a.y<=d.y+d.h+e&&(c=0)),{x:b,y:c}},e.prototype.applyOrigin=function(a){var b=a.x,c=a.y;return"undefined"==typeof b&&"undefined"==typeof c?void(this.state=e.STATE_MOVE):(this.state=e.STATE_RESIZE,void(this.direction="undefined"!=typeof b&&"undefined"!=typeof c?e.DIRECTION_BOTH:"undefined"!=typeof b?e.DIRECTION_HORIZONTAL:e.DIRECTION_VERTICAL))},e.prototype.getCursor=function(a){return a?"undefined"==typeof a.x?"undefined"==typeof a.y?"move":"ns-resize":a.x?"undefined"==typeof a.y?"ew-resize":a.y?"nwse-resize":"nesw-resize":"undefined"==typeof a.y?"ew-resize":a.y?"nesw-resize":"nwse-resize":"default"},e.prototype.setCursor=function(a){this.cursor!==a&&(this.elements.$container.css("cursor",a),this.cursor=a)},e.prototype.selection=d,e.prototype.drag={},e.prototype.dragStart=function(a){var b,c=this.convertPoint(e.getPointFromEvent(a)),d=this.options;if(this.testComponentHit(c)){if(!this.testSelectionHit(c)){if(this.selection){if(d.persistent)return void a.preventDefault()}else this.selection={};this.selection.x=c.x,this.selection.y=c.y,this.selection.w=0,this.selection.h=0}if(this.mode=a.altKey?e.MODE_CENTER:e.MODE_NORMAL,a.preventDefault(),b=this.getOrigin(c),this.applyOrigin(b),this.state===e.STATE_MOVE){if(!d.movable)return void(this.state=e.STATE_NULL);this.drag.point={x:c.x,y:c.y},this.drag.init={x:c.x,y:c.y},this.drag.original={x:this.selection.x,y:this.selection.y}}else{if(!d.resizable)return void(this.state=e.STATE_NULL);this.drag.point={x:c.x,y:c.y},this.drag.end=function(a){var c,d;return"undefined"!=typeof b.x&&(c=a.selection.x+a.selection.w*b.x),"undefined"!=typeof b.y&&(d=a.selection.y+a.selection.h*b.y),{x:c,y:d}}(this),this.drag.center=function(a){var c,d;return"undefined"!=typeof b.x&&(c=a.selection.x+.5*a.selection.w),"undefined"!=typeof b.y&&(d=a.selection.y+.5*a.selection.h),{x:c,y:d}}(this)}"function"==typeof this.options.onstart&&this.options.onstart(this.convertSelection(this.selection)),this.setCursor(this.getCursor(b))}},e.prototype.dragMove=function(a){var b=this.convertPoint(e.getPointFromEvent(a));this.mode=a.altKey?e.MODE_CENTER:e.MODE_NORMAL,this.state!==e.STATE_NULL&&(a.preventDefault(),this.drag.point=b,this.updateSelection(),"function"==typeof this.options.onchange&&this.options.onchange(this.convertSelection(this.selection))),this.setCursor(this.getCursor(this.getOrigin(b)))},e.prototype.dragEnd=function(a){a.preventDefault(),this.mode=a.altKey?e.MODE_CENTER:e.MODE_NORMAL,this.state!==e.STATE_NULL&&(this.state=e.STATE_NULL,"function"==typeof this.options.onend&&this.options.onend(this.convertSelection(this.selection))),this.setCursor(this.getCursor(this.getOrigin(this.convertPoint(e.getPointFromEvent(a)))))},e.prototype.updateSelection=function(){var a,b,c=this.selection,d=this.drag;this.state===e.STATE_MOVE?(c.x=d.original.x+d.point.x-d.init.x,c.y=d.original.y+d.point.y-d.init.y):this.direction===e.DIRECTION_BOTH?(a=this.getDimension(e.DIRECTION_HORIZONTAL),b=this.getDimension(e.DIRECTION_VERTICAL),c.x=a.position,c.w=a.length,c.y=b.position,c.h=b.length):this.direction===e.DIRECTION_VERTICAL?(b=this.getDimension(e.DIRECTION_VERTICAL),c.y=b.position,c.h=b.length):(a=this.getDimension(e.DIRECTION_HORIZONTAL),c.x=a.position,c.w=a.length),c.x<0?c.x=0:c.x+c.w>1&&(c.x-=c.x+c.w-1),c.y<0?c.y=0:c.y+c.h>1&&(c.y-=c.y+c.h-1),this.requestUpdate()},e.prototype.getDimension=function(a){var b,c,d,f,g,h;return a===e.DIRECTION_HORIZONTAL?(b=this.drag.point.x,g=this.options.min.wp,h=this.options.max.wp,c=this.mode===e.MODE_NORMAL?this.drag.end.x:this.drag.center.x):(b=this.drag.point.y,g=this.options.min.hp,h=this.options.max.hp,c=this.mode===e.MODE_NORMAL?this.drag.end.y:this.drag.center.y),this.mode===e.MODE_NORMAL?(h=b>c?Math.min(1-c,h):Math.min(c,h),Math.abs(b-c)>h&&(b=b>c?c+h:c-h),Math.abs(b-c)<g&&(b=b>c?c+g:c-g),b>c?(d=c,f=b-c):(d=b,f=c-b)):(h=Math.min(2*c,2*(1-c),h),Math.abs(2*(b-c))>h&&(b=b>c?c+h/2:c-h/2),Math.abs(2*(b-c))<g&&(b=b>c?c+g/2:c-g/2),b>c?(d=2*c-b,f=2*(b-c)):(d=b,f=2*(c-b))),{position:d,length:f}},c.croptool=function(a,b){if("string"==typeof a)switch(a){case"defaults":return"undefined"!=typeof b&&(e.defaults=c.extend(e.defaults,b)),e.defaults}},c.fn.croptool=function(a){var b;return"string"!=typeof a?(b=c.extend(e.defaults,a),this.each(function(){new e(this,b)})):void 0}}(window,document,window.jQuery);